<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRIS | Detalhes do Contrato</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --iris-black: #05070a;
            --iris-gold: #c5a059;
            --bg-soft: #f4f7f9;
            --white: #ffffff;
            --text-dark: #1a1a1a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --info: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-soft);
            color: var(--text-dark);
            padding: 40px 20px;
        }

        .container { max-width: 900px; margin: auto; }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-top: 6px solid var(--iris-black);
        }

        header.card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
            padding-bottom: 20px;
        }

        h1 { font-family: 'Cinzel', serif; font-size: 22px; letter-spacing: 1px; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .full-width { grid-column: span 2; }
        
        .label {
            display: block;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--iris-gold);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: 0.3s;
        }

        input:disabled, textarea:disabled, select:disabled {
            background: #f8fafc;
            border-color: transparent;
            color: var(--text-dark);
        }

        .memorial-container {
            grid-column: span 2;
            background: #fffbeb;
            border: 1px solid #fef3c7;
            padding: 20px;
            border-radius: 12px;
        }

        .actions-group {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn-iris {
            flex: 1;
            min-width: 160px;
            padding: 14px 20px;
            border-radius: 50px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .btn-finish {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }
        .btn-finish:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .btn-edit {
            background: var(--white);
            color: var(--iris-gold);
            border: 2px solid var(--iris-gold);
        }
        .btn-edit:hover {
            background: var(--iris-gold);
            color: white;
        }

        .btn-delete-link {
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            text-decoration: underline;
            border: none;
            cursor: pointer;
            align-self: center;
            margin-top: 10px;
        }
        .btn-delete-link:hover { color: var(--danger); }

        .btn-save { background: var(--iris-black); color: white; display: none; width: 100%; }

        @media (max-width: 600px) { .info-grid { grid-template-columns: 1fr; } .main-buttons { flex-direction: column; } }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div class="container">
        <nav style="margin-bottom: 20px;">
            <a href="index.html" style="text-decoration:none; color: var(--text-muted); font-size:12px; font-weight:bold;">
                <i data-lucide="arrow-left" style="width:12px"></i> VOLTAR
            </a>
        </nav>

        <div id="loader" style="text-align:center; padding: 50px;">
            <p>Carregando...</p>
        </div>

        <div id="conteudo-detalhes" class="card" style="display:none;">
            <header class="card-header">
                <h1 id="titulo-cliente">---</h1>
                <span id="badge-id" class="label" style="margin-bottom:0">ID: ---</span>
            </header>

            <form id="form-contrato">
                <input type="hidden" id="codigo_contrato_original">

                <div class="info-grid">
                    <div class="info-group full-width">
                        <span class="label">Locatário</span>
                        <input type="text" id="det-locatario" disabled>
                    </div>

                    <div class="info-group full-width">
                        <span class="label">Locadora</span>
                        <input type="text" id="det-locadora" disabled>
                    </div>

                    <div class="info-group">
                        <span class="label">Início</span>
                        <input type="text" id="det-inicio" disabled>
                    </div>

                    <div class="info-group">
                        <span class="label">Vencimento</span>
                        <input type="text" id="det-vencimento" disabled>
                    </div>

                    <div class="info-group">
                        <span class="label">Valor Aluguel</span>
                        <input type="text" id="det-valor" disabled>
                    </div>

                    <div class="info-group">
                        <span class="label">Índice</span>
                        <input type="text" id="det-indice" disabled>
                    </div>

                    <div class="info-group full-width">
                        <span class="label">Garantia</span>
                        <input type="text" id="det-garantia" disabled>
                    </div>

                    <div class="info-group full-width">
                        <span class="label">Multa Rescisória</span>
                        <textarea id="det-multa" rows="2" disabled></textarea>
                    </div>

                    <div class="info-group full-width">
                        <span class="label">Resumo Analítico (IA)</span>
                        <textarea id="det-resumo" rows="3" disabled></textarea>
                    </div>

                    <div class="memorial-container">
                        <span class="label">Observações Jurídicas</span>
                        <textarea id="det-notas" rows="3" disabled style="background:transparent; border:none;"></textarea>
                    </div>

                    <div class="info-group">
                        <span class="label">Status Operacional</span>
                        <select id="det-status" disabled>
                            <option value="Em andamento">Em andamento</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>

                    <div class="info-group">
                        <span class="label">Contrato PDF</span>
                        <a id="link-pdf" href="#" target="_blank" style="text-decoration:none; color:var(--info); font-size:13px; font-weight:bold; display:flex; align-items:center; gap:5px; margin-top:10px;">
                            <i data-lucide="file-text" size="16"></i> ABRIR DOCUMENTO
                        </a>
                    </div>
                </div>

                <div class="actions-group">
                    <div class="main-buttons">
                        <button type="button" id="btn-finalizar" class="btn-iris btn-finish" onclick="finalizarPrazo()">
                            <i data-lucide="check-circle" size="18"></i> Concluir Etapa
                        </button>

                        <button type="button" id="btn-editar" class="btn-iris btn-edit" onclick="habilitarEdicao()">
                            <i data-lucide="edit-3" size="18"></i> Editar Dados
                        </button>
                    </div>

                    <button type="button" id="btn-salvar" class="btn-iris btn-save" onclick="salvarAlteracoes()">
                        <i data-lucide="save" size="18"></i> Sincronizar Alterações
                    </button>

                    <button type="button" id="btn-retirar" class="btn-delete-link" onclick="abrirModal()">
                        Retirar processo do sistema
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalDelete" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; padding:30px; border-radius:15px; max-width:350px; text-align:center;">
            <h3 style="margin-bottom:10px;">Excluir registro?</h3>
            <p style="font-size:13px; color:var(--text-muted); margin-bottom:20px;">Esta ação removerá o registro permanentemente.</p>
            <div style="display:flex; gap:10px;">
                <button onclick="fecharModal()" style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--border); background:none; cursor:pointer;">Cancelar</button>
                <button id="btn-confirmar-exclusao" onclick="confirmarExclusao()" style="flex:1; padding:10px; border-radius:8px; background:var(--danger); color:white; border:none; cursor:pointer;">Excluir</button>
            </div>
        </div>
    </div>

    <script>
    lucide.createIcons();

    async function carregarFicha() {
        const urlParams = new URLSearchParams(window.location.search);
        const idBusca = urlParams.get('id');
        if (!idBusca) return;

        try {
            const response = await fetch("https://vissionlet.com/n8n/webhook/buscarprazosativos");
            const lista = await response.json();
            const contrato = lista.find(c => String(c.codigo_contrato) === String(idBusca));

            if (contrato) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('conteudo-detalhes').style.display = 'block';
                document.getElementById('titulo-cliente').innerText = contrato.locatario;
                document.getElementById('badge-id').innerText = "ID: " + contrato.codigo_contrato;
                document.getElementById('codigo_contrato_original').value = contrato.codigo_contrato;
                
                document.getElementById('det-locatario').value = contrato.locatario || '';
                document.getElementById('det-locadora').value = contrato.locadora || '';
                document.getElementById('det-inicio').value = contrato.inicio_aditamento || '';
                document.getElementById('det-vencimento').value = contrato.termino_aditamento || '';
                document.getElementById('det-valor').value = contrato.valor_aluguel || '';
                document.getElementById('det-indice').value = contrato.indice_reajuste || '';
                document.getElementById('det-garantia').value = contrato.garantia || '';
                document.getElementById('det-multa').value = contrato.multa_rescisoria || '';
                document.getElementById('det-resumo').value = contrato.resumo_contexto || '';
                document.getElementById('det-notas').value = contrato.notas_advogado || '';
                document.getElementById('det-status').value = contrato.estatus || 'Em andamento';
                
                if (contrato.PDF) {
                    document.getElementById('link-pdf').href = contrato.PDF;
                }
            }
        } catch (e) { 
            console.error("Erro ao carregar dados:", e);
            document.getElementById('loader').innerHTML = "<p>Erro ao carregar dados.</p>";
        }
    }

    function habilitarEdicao() {
        document.querySelectorAll('input, textarea, select').forEach(el => {
            if(el.id !== 'codigo_contrato_original') el.disabled = false;
        });
        document.getElementById('btn-editar').style.display = 'none';
        document.getElementById('btn-finalizar').style.display = 'none';
        document.getElementById('btn-salvar').style.display = 'flex';
    }

    async function salvarAlteracoes() {
        const btn = document.getElementById('btn-salvar');
        const originalText = btn.innerHTML;
        const dadosAtualizados = {
            codigo_contrato: document.getElementById('codigo_contrato_original').value,
            locatario: document.getElementById('det-locatario').value,
            locadora: document.getElementById('det-locadora').value,
            inicio_aditamento: document.getElementById('det-inicio').value,
            termino_aditamento: document.getElementById('det-vencimento').value,
            valor_aluguel: document.getElementById('det-valor').value,
            indice_reajuste: document.getElementById('det-indice').value,
            garantia: document.getElementById('det-garantia').value,
            multa_rescisoria: document.getElementById('det-multa').value,
            resumo_contexto: document.getElementById('det-resumo').value,
            notas_advogado: document.getElementById('det-notas').value,
            estatus: document.getElementById('det-status').value
        };

        try {
            btn.disabled = true;
            btn.innerHTML = "<i data-lucide='refresh-cw' class='spin'></i> Sincronizando...";
            lucide.createIcons();

            const response = await fetch("https://vissionlet.com/n8n/webhook/atualizar-prazo", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dadosAtualizados)
            });

            if (response.ok) {
                alert("Dados atualizados com sucesso!");
                window.location.reload();
            } else {
                throw new Error("Erro no servidor");
            }
        } catch (e) {
            alert("Erro ao salvar alterações.");
            btn.disabled = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
        }
    }

    async function finalizarPrazo() {
        const id = document.getElementById('codigo_contrato_original').value;
        const btn = document.getElementById('btn-finalizar');
        if(!confirm("Deseja marcar este prazo como concluído?")) return;
        
        try {
            btn.disabled = true;
            btn.innerText = "Concluindo...";
            
            const response = await fetch("https://vissionlet.com/n8n/webhook/finalizar", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ codigo_contrato: id })
            });

            if(response.ok) {
                window.location.href = 'index.html';
            }
        } catch (e) { 
            alert("Erro ao finalizar."); 
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="check-circle" size="18"></i> Concluir Etapa';
            lucide.createIcons();
        }
    }

    function abrirModal() { document.getElementById('modalDelete').style.display = 'flex'; }
    function fecharModal() { document.getElementById('modalDelete').style.display = 'none'; }

    // --- FUNÇÃO DE EXCLUSÃO COM CONTROLE DE TEMPO MELHORADO ---
    async function confirmarExclusao() {
        const id = document.getElementById('codigo_contrato_original').value;
        const btn = document.getElementById('btn-confirmar-exclusao');
        
        btn.disabled = true;
        btn.innerText = "Apagando...";

        // Criamos um controller para poder cancelar a espera se demorar demais
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 35000); // 35 segundos de espera

        try {
            const response = await fetch("https://vissionlet.com/n8n/webhook/apagar", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (response.ok) {
                window.location.href = 'index.html';
            } else {
                // Se o erro for 504 ou 502 (Timeout do Servidor), mas o n8n deletou, redirecionamos
                console.warn("Servidor demorou, mas pode ter processado.");
                window.location.href = 'index.html';
            }
        } catch (e) { 
            if (e.name === 'AbortError') {
                // Se deu timeout, provavelmente o n8n completou a tarefa mas não avisou a tempo
                window.location.href = 'index.html';
            } else {
                alert("Erro ao conectar com o servidor.");
                btn.disabled = false;
                btn.innerText = "Excluir";
            }
        }
    }

    window.onload = carregarFicha;
</script>
</body>
</html>